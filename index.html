<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–°–∫–ª–∞–¥ –ö—É—Ä—Å–æ–≤ - –ó–∞–≥—Ä—É–∑–∫–∞...</title>
    
    <!-- PWA –¥–ª—è Mini App -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3b82f6">
    
    <!-- Favicon -->
    <link rel="icon" href="./logo.webp">
    <link rel="apple-touch-icon" href="./logo.webp">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --color-bg: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            --color-surface: #ffffff;
            --color-border: #e2e8f0;
            --color-text: #0f172a;
            --color-text-muted: #64748b;
            --color-accent: #3b82f6;
            --color-accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --color-success: #10b981;
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
            --shadow-colored: 0 8px 24px rgba(59, 130, 246, 0.2);
            --radius-lg: 20px;
            --radius-pill: 999px;
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --color-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --color-surface: #1e293b;
            --color-border: #475569;
            --color-text: #f1f5f9;
            --color-text-muted: #cbd5e1;
            --color-accent: #60a5fa;
            --color-accent-gradient: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            --color-success: #34d399;
            --shadow-colored: 0 8px 24px rgba(96, 165, 250, 0.4);
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
            background-attachment: fixed;
            color: var(--color-text);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .logo {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-lg);
            background: var(--color-accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 32px;
            box-shadow: var(--shadow-colored);
            animation: pulse 2s infinite;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: var(--shadow-colored);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 12px 32px rgba(59, 130, 246, 0.4);
            }
        }

        .title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
            background: var(--color-accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 16px;
            color: var(--color-text-muted);
            margin-bottom: 40px;
            max-width: 400px;
            line-height: 1.5;
        }

        .loading-bar {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background: var(--color-border);
            border-radius: var(--radius-pill);
            overflow: hidden;
            margin-bottom: 24px;
            position: relative;
        }

        .loading-progress {
            height: 100%;
            background: var(--color-accent-gradient);
            border-radius: var(--radius-pill);
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .loading-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .status {
            font-size: 14px;
            color: var(--color-text-muted);
            margin-bottom: 16px;
            min-height: 20px;
        }

        .steps {
            list-style: none;
            padding: 0;
            margin: 0;
            max-width: 350px;
            text-align: left;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            font-size: 14px;
            color: var(--color-text-muted);
        }

        .step.completed {
            color: var(--color-success);
        }

        .step.active {
            color: var(--color-accent);
            font-weight: 500;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            border: 2px solid currentColor;
            flex-shrink: 0;
        }

        .step.completed .step-icon {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .step.active .step-icon {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-top: 20px;
            max-width: 400px;
        }

        .error-title {
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-message {
            color: var(--color-text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .retry-btn {
            background: var(--color-accent-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius-pill);
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all var(--transition-base);
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-colored);
        }

        /* Debug panel –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 300px;
            display: none;
            z-index: 1000;
        }

        .debug-panel.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <img src="./logo.webp" alt="–°–∫–ª–∞–¥ –ö—É—Ä—Å–æ–≤" onerror="this.style.display='none'">
        </div>
        
        <h1 class="title">–°–∫–ª–∞–¥ –ö—É—Ä—Å–æ–≤</h1>
        <p class="subtitle">–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç...</p>
        
        <div class="loading-bar">
            <div class="loading-progress" id="progress"></div>
        </div>
        
        <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
        
        <!-- –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è -->
        <div class="error" id="error" style="display: none;">
            <div class="error-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
            <div class="error-message" id="error-message"></div>
            <button class="retry-btn" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <!-- Debug panel -->
    <div class="debug-panel" id="debug-panel">
        <div><strong>Debug Info:</strong></div>
        <div id="debug-content"></div>
    </div>

    <script>
        // –ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫ Netlify ‚Üí –û—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç
        // –¶–µ–ª—å: –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram, –ø–µ—Ä–µ–¥–∞—Ç—å –∏—Ö –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç
        
        const MAIN_SITE_URL = 'https://skladkursob.22web.org';
        const DEBUG_MODE = window.location.search.includes('debug=1');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫–∞
        let telegramData = null;
        let currentStep = 0;
        let transferProgress = 0;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const progressBar = document.getElementById('progress');
        const statusElement = document.getElementById('status');
        const errorElement = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const debugPanel = document.getElementById('debug-panel');
        const debugContent = document.getElementById('debug-content');

        if (DEBUG_MODE) {
            debugPanel.classList.add('visible');
        }

        function debugLog(message) {
            console.log(message);
            if (DEBUG_MODE) {
                const time = new Date().toLocaleTimeString();
                debugContent.innerHTML += `<div>[${time}] ${message}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function updateProgress(percent, status) {
            transferProgress = Math.min(100, Math.max(0, percent));
            progressBar.style.width = transferProgress + '%';
            if (status) {
                statusElement.textContent = status;
            }
            debugLog(`Progress: ${transferProgress}% - ${status || ''}`);
        }

        function setStep(stepNumber, status = 'active') {
            // –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step-${i}`);
                step.classList.remove('active', 'completed');
                
                if (i < stepNumber) {
                    step.classList.add('completed');
                    step.querySelector('.step-icon').textContent = '‚úì';
                } else if (i === stepNumber && status === 'active') {
                    step.classList.add('active');
                    step.querySelector('.step-icon').textContent = i;
                } else {
                    step.querySelector('.step-icon').textContent = i;
                }
            }
            currentStep = stepNumber;
        }

        function showError(title, message) {
            errorElement.style.display = 'block';
            errorElement.querySelector('.error-title').textContent = title;
            errorMessage.textContent = message;
            debugLog(`ERROR: ${title} - ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–±–æ—Ä–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram
        function collectTelegramData() {
            debugLog('üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö Telegram...');
            
            const data = {
                // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user: null,
                initData: null,
                initDataUnsafe: null,
                
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                startParam: null,
                platform: null,
                version: null,
                colorScheme: null,
                themeParams: null,
                
                // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–∑ netlify_ startParam
                searchParams: null,
                
                // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    devicePixelRatio: window.devicePixelRatio || 1
                },
                
                // URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞)
                urlParams: {},
                
                // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                timestamp: Date.now(),
                userAgent: navigator.userAgent,
                language: navigator.language,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                
                // –§–ª–∞–≥ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
                isTelegramMiniApp: false
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram Web App
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                data.isTelegramMiniApp = true;
                
                debugLog('‚úÖ Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
                tg.ready();
                tg.expand();
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    data.user = tg.initDataUnsafe.user;
                    debugLog(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${data.user.first_name} (ID: ${data.user.id})`);
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                data.initData = tg.initData || null;
                data.initDataUnsafe = tg.initDataUnsafe || null;
                data.startParam = tg.initDataUnsafe?.start_param || null;
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º netlify_ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞
                if (data.startParam && data.startParam.startsWith('netlify_')) {
                    debugLog('üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω netlify_ –ø–∞—Ä–∞–º–µ—Ç—Ä');
                    try {
                        const encodedParams = data.startParam.substring(8); // –£–±–∏—Ä–∞–µ–º "netlify_"
                        debugLog('üîç –ó–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ' + encodedParams);
                        
                        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64url
                        let base64 = encodedParams.replace(/-/g, '+').replace(/_/g, '/');
                        while (base64.length % 4) {
                            base64 += '=';
                        }
                        
                        // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ UTF-8 –∏–∑ base64
                        const binaryString = atob(base64);
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç–æ–≤
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        // –î–µ–∫–æ–¥–∏—Ä—É–µ–º UTF-8
                        const decodedParams = new TextDecoder('utf-8').decode(bytes);
                        debugLog('üîç –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ' + decodedParams);
                        
                        // –ü–∞—Ä—Å–∏–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                        const urlParams = new URLSearchParams(decodedParams);
                        data.searchParams = {
                            find: urlParams.get('find') || '',
                            nalich: urlParams.get('nalich') || 'available',
                            poiskpo: urlParams.get('poiskpo') || 'title'
                        };
                        
                        debugLog('‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω—ã: ' + JSON.stringify(data.searchParams));
                    } catch (error) {
                        debugLog('‚ùå –û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è netlify_ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: ' + error.message);
                        data.searchParams = null;
                    }
                }
                data.platform = tg.platform || null;
                data.version = tg.version || null;
                data.colorScheme = tg.colorScheme || null;
                data.themeParams = tg.themeParams || null;
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                data.telegramViewport = {
                    height: tg.viewportHeight || null,
                    stableHeight: tg.viewportStableHeight || null,
                    isExpanded: tg.isExpanded || false
                };
                
                debugLog(`üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${data.platform}, –í–µ—Ä—Å–∏—è: ${data.version}`);
                debugLog(`üé® –¢–µ–º–∞: ${data.colorScheme}`);
                
                if (data.startParam) {
                    debugLog(`üîó Start –ø–∞—Ä–∞–º–µ—Ç—Ä: ${data.startParam}`);
                }
                
                // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —Ç–µ–º—É –ø–æ–¥ Telegram
                if (tg.colorScheme === 'dark') {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                
            } else {
                debugLog('‚ö†Ô∏è Telegram Web App –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω, —Ä–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä');
                
                // –°–æ–±–∏—Ä–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
                const urlParams = new URLSearchParams(window.location.search);
                for (const [key, value] of urlParams.entries()) {
                    data.urlParams[key] = value;
                }
                
                debugLog(`üåê URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: ${JSON.stringify(data.urlParams)}`);
            }
            
            return data;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è URL –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞
        function buildMainSiteUrl(telegramData) {
            debugLog('üîó –°—Ç—Ä–æ–∏–º URL –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç–∞...');
            
            const url = new URL(MAIN_SITE_URL);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram Mini App
            if (telegramData.isTelegramMiniApp) {
                // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (telegramData.user) {
                    url.searchParams.set('tg_user_id', telegramData.user.id);
                    url.searchParams.set('tg_first_name', telegramData.user.first_name || '');
                    url.searchParams.set('tg_last_name', telegramData.user.last_name || '');
                    url.searchParams.set('tg_username', telegramData.user.username || '');
                    url.searchParams.set('tg_language_code', telegramData.user.language_code || '');
                }
                
                // –ü–µ—Ä–µ–¥–∞–µ–º start_param –µ—Å–ª–∏ –µ—Å—Ç—å
                if (telegramData.startParam) {
                    url.searchParams.set('start_param', telegramData.startParam);
                }
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∏ –≤–µ—Ä—Å–∏—é
                if (telegramData.platform) {
                    url.searchParams.set('tg_platform', telegramData.platform);
                }
                
                if (telegramData.version) {
                    url.searchParams.set('tg_version', telegramData.version);
                }
                
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–º—É
                if (telegramData.colorScheme) {
                    url.searchParams.set('tg_theme', telegramData.colorScheme);
                }
                
                // –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (telegramData.searchParams) {
                    url.searchParams.set('find', telegramData.searchParams.find);
                    url.searchParams.set('nalich', telegramData.searchParams.nalich);
                    url.searchParams.set('poiskpo', telegramData.searchParams.poiskpo);
                    debugLog('üîç –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –≤ URL: ' + JSON.stringify(telegramData.searchParams));
                }
                
                // –§–ª–∞–≥ —á—Ç–æ –ø—Ä–∏—à–ª–∏ —á–µ—Ä–µ–∑ Netlify –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫
                url.searchParams.set('via_netlify', '1');
                url.searchParams.set('netlify_timestamp', telegramData.timestamp);

                // –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º initData –≤ base64, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π URL
                if (telegramData.initData) {
                    // btoa —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å ASCII, –ø–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –µ—Å—Ç—å unicode (—Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã), –Ω–∞–¥–æ —Å–Ω–∞—á–∞–ª–∞ –∏—Ö –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
                    // –ù–æ initData –æ—Ç Telegram –æ–±—ã—á–Ω–æ —É–∂–µ url-encoded, —Ç–∞–∫ —á—Ç–æ —Ç–∞–º ASCII.
                    // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–µ–ª–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ:
                    try {
                        url.searchParams.set('tg_init_data', btoa(telegramData.initData));
                    } catch (e) {
                        // Fallback –µ—Å–ª–∏ btoa —É–ø–∞–¥–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä –∏–∑-–∑–∞ unicode)
                        console.error('Base64 encode failed', e);
                        url.searchParams.set('tg_init_data', telegramData.initData);
                    }
                }
                
                debugLog(`‚úÖ URL –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å Telegram –¥–∞–Ω–Ω—ã–º–∏`);
            } else {
                // –ü–µ—Ä–µ–¥–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞
                for (const [key, value] of Object.entries(telegramData.urlParams)) {
                    url.searchParams.set(key, value);
                }
                
                // –§–ª–∞–≥ —á—Ç–æ –ø—Ä–∏—à–ª–∏ —á–µ—Ä–µ–∑ Netlify –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫
                url.searchParams.set('via_netlify', '1');
                url.searchParams.set('netlify_timestamp', telegramData.timestamp);
                
                debugLog(`‚úÖ URL –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏`);
            }
            
            const finalUrl = url.toString();
            debugLog(`üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π URL: ${finalUrl}`);
            
            return finalUrl;
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫–∞
        async function startTransfer() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            statusElement.textContent = '–ü–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö Telegram...';
            progressBar.style.width = '30%';
            
            // –ú–ï–•–ê–ù–ò–ó–ú POLLING (–¶–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 4 —Å–µ–∫—É–Ω–¥ (–¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
            const maxAttempts = 40; // 40 –ø–æ–ø—ã—Ç–æ–∫ –ø–æ 100–º—Å = 4 —Å–µ–∫—É–Ω–¥—ã
            let attempts = 0;
            
            const checkInterval = setInterval(() => {
                attempts++;
                
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    const tg = window.Telegram.WebApp;
                    
                    // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    // initDataUnsafe.user –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        clearInterval(checkInterval);
                        debugLog('‚úÖ –î–∞–Ω–Ω—ã–µ Telegram –Ω–∞–π–¥–µ–Ω—ã!');
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –°–†–ê–ó–£ –ñ–ï
                        const telegramData = collectTelegramData();
                        redirectToMainSite(telegramData);
                        return;
                    }
                }
                
                // –ï—Å–ª–∏ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    debugLog('‚ö†Ô∏è –¢–∞–π–º-–∞—É—Ç –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –†–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä.');
                    
                    // –°–æ–±–∏—Ä–∞–µ–º —á—Ç–æ –µ—Å—Ç—å (–ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
                    const fallbackData = collectTelegramData();
                    redirectToMainSite(fallbackData);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
                const progress = 30 + (attempts / maxAttempts) * 40; // –æ—Ç 30% –¥–æ 70%
                progressBar.style.width = progress + '%';
                
            }, 100); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 100–º—Å
        }

        function redirectToMainSite(telegramData) {
            statusElement.textContent = '–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç...';
            progressBar.style.width = '100%';
            
            const mainSiteUrl = buildMainSiteUrl(telegramData);
            debugLog(`üöÄ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞: ${mainSiteUrl}`);
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
            window.location.href = mainSiteUrl;
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫
        window.addEventListener('load', () => {
            debugLog('üì± –ü–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫ Netlify –∑–∞–ø—É—â–µ–Ω');
            startTransfer();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (event) => {
            debugLog(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${event.error?.message || event.message}`);
            showError('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        });

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ç–µ–º–Ω—É—é —Ç–µ–º—É (–µ—Å–ª–∏ Telegram –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            if (!window.Telegram?.WebApp?.colorScheme) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }
    </script>
</body>

</html>

